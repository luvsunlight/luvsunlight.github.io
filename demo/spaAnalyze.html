<!doctype html>
<html lang="zh">
  <head>
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
    <link href="https://cdn.bootcss.com/leaflet.fullscreen/1.4.3/Control.FullScreen.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/leaflet.draw/0.4.13/leaflet.draw.css" rel="stylesheet">
    <style>
    html, body, .main-wrap {
              margin: 0;
              width: 100%;
              height: 100%;
              overflow: hidden;
          }

    /*工具栏toggle*/
    .edit {
        position: absolute;
        top: 90%;
        left: 1%;
        z-index: 1000;

        background-color: #fff
    }

    /*主体部分*/

    /*左侧的sidebar*/
    #tool-wrap {
        position: absolute;
        width: 16%;
        height: 100%;
        background-color: #2c3e50;
        color: #ecf0f1
    }
    .panel {
        border: none;
        background-color: #34495e;
        margin-top: 0!important;
    }
    .panel-heading {
        background-color: #1abc9c;
        color: #2c3e50
    }

    .choice {
        padding: 5px 10px;
    }

    .choice:hover{
        color: #1bbc9c !important;
        cursor: pointer
    }
    i {
        margin-right: 3px;
    }

    #collapseFour div {
        margin-bottom: 40px;
    }

    #collapseFour span {
        float: left;
    }

    #collapseFour input {
        float: right;
        width: 40%;
        margin-left: 10%;
        color: #fff;
        background-color: #7f8c8d;
        border: none;
        text-indent: .5em;
        outline: none;
    }
    #collapseFour input::-webkit-input-placeholder {
        color: #ccc
    }

    /* 地图 */
    #map {
        margin-left: 16%;
        float: left;
        width: 100%;
        height: 100%;
    }

    /* DIY Icons */
    .iconBlue {
        border-radius: 50%;
        border: 3px solid #fff;
        background-color: #2980b9;
        box-shadow: 2px 2px 3px rgba(0,0,0,0.44)
    }
    .iconRed {
        border-radius: 50%;
        border: 3px solid #fff;
        background-color: #e74c3c;
        box-shadow: 2px 2px 3px rgba(0,0,0,0.44)
    }
    .iconGreen {
        border-radius: 50%;
        border: 3px solid #fff;
        background-color: #1bbc9c;
        box-shadow: 2px 2px 3px rgba(0,0,0,0.44)
    }

    /* 消息盒子部分 */
    .message-box {
        display: none;
        position: absolute;
        top: 33%;
        left: 33%;
        width: 400px;
        height: 160px;
        color: #777;
        background: #fff;
        box-shadow: 0 35px 77px -17px rgba(0,0,0,0.44);
        z-index: 1001;

    }
    .msgTitle {
        padding: 2% 5%;
        border-bottom: 1px solid #eee;
        font-size: 18px;
    }
    .msgContent {
        padding: 3% 0;
        text-indent: 2em;
        font-size: 16px;
    }
    .msgBtn {
        position: absolute;
        bottom: 10%;
        right: 5%;
        padding: 1% 3%;
        color: #555;
        background: rgba(232,191,188,.5);
    }

    </style>
    <!-- Mapping js -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="https://cdn.bootcss.com/leaflet.fullscreen/1.4.3/Control.FullScreen.js"></script>
    <script src="https://cdn.bootcss.com/leaflet-providers/1.1.17/leaflet-providers.min.js"></script>
    <script src="https://cdn.bootcss.com/leaflet.draw/0.4.13/leaflet.draw.js"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <!-- Util js  -->
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
	<script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <title>空间分析</title>
  </head>
  <body>

    <!-- 主体 -->
    <div class="main-wrap">

        <!-- 配置部分 -->
        <div id="tool-wrap">
            <div class="panel-group" id="accordion">
                <div class="panel panel-layer">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion"
                            href="#collapseOne">
                            <i class="fa fa-pencil"></i>
                             数据处理
                            </a>
                        </h4>
                    </div>
                    <div id="collapseOne" class="collapse in">
                        <div class="panel-body">
                            <div class="addMarker choice">
                                添加标记点
                            </div>
                            <div class="delMarker choice">
                                删除标记点
                            </div>
                            <div class="delAllMarkers choice">
                                清空所有标记点
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel panel-layer">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion"
                            href="#collapseTwo">
                            <i class="fa fa-paint-brush"></i>
                            底图风格
                            </a>
                        </h4>
                    </div>
                    <div id="collapseTwo" class="collapse in">
                        <div class="panel-body">
                            <div id="Stamen.Watercolor" class="layer choice">水彩地图</div>
                            <div id="OpenMapSurfer.Roads" class="layer choice">OSM路网</div>
                            <div id="Stamen.TonerLite" class="layer choice">黑白地图</div>
                            <div id="CartoDB.DarkMatter" class="layer choice">mapbox风格</div>
                            <div id="OpenTopoMap" class="layer choice">地形图</div>
                        </div>
                    </div>
                </div>
                <div class="panel panel-layer">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion"
                            href="#collapseThree">
                            <i class="fa fa-magic"></i>
                            空间分析
                            </a>
                        </h4>
                    </div>
                    <div id="collapseThree" class="collapse in">
                        <div class="panel-body">
                            <div id="convex" class="choice">生成凸包</div>
                            <div id="bbox" class="choice">生成最小外接矩形</div>
                            <div id="tin" class="choice">生成三角网</div>
                            <div id="voronoi" class="choice">生成voronoi图</div>
                            <div id="buffer" class="choice">生成缓冲区</div>
                            <div id="clustersKmeans" class="choice">K-means聚类</div>
                        </div>
                    </div>
                </div>
                <div class="panel panel-layer">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion"
                            href="#collapseFour">
                            <i class="fa fa-cog"></i>
                            基本设置
                            </a>
                        </h4>
                    </div>
                    <div id="collapseFour" class="collapse">
                        <div class="panel-body">
                            <div>
                                <span>缓冲区半径</span>
                                <input type="text" id="editRadius" placeholder="默认:0.5">
                            </div>
                            <div>
                                <span>聚类个数</span>
                                <input type="text" id="editClusterNums" placeholder="默认:2">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--可视化部分 -->
        <div id="map">
            <div class="edit">
                <a class="btn btn-default">
                  <i class="fa fa-bars fa-2x" aria-hidden="true"></i>
                </a>
            </div>
        </div>

        <!--消息盒子-->
        <div class="message-box">
            <div class="msgTitle">提示</div>
            <div class="msgContent"></div>
            <botton class="msgBtn">确定</botton>
        </div>


    </div>

    <script type="text/javascript">

    $(document).ready(function(){
        GLOBE = initGlobe();
        initEvent();
        initMap();
        initNav();
        initEdit();
        initLayers();
        initAnalyse();
    })

    function initGlobe() {
        var globe = {};
        globe.toolVis = false;
        globe.setMarker = false;
        globe.delMarker = false;
        globe.layerList = {};
        globe.spaLayer = {};
        globe.markerCoords = [];
        globe.markers = [];

        globe.colors = {
            "darkGreen":"#1bbc9c",
            "white":"#fff"
        };

        globe.icons = [
            L.divIcon({
            className: 'iconBlue',
            iconAnchor: L.point(10,0),
            iconSize: L.point(20,20)}),

            L.divIcon({
            className: 'iconRed',
            iconAnchor: L.point(10,0),
            iconSize: L.point(20,20)}),

            L.divIcon({
            className: 'iconGreen',
            iconAnchor: L.point(10,0),
            iconSize: L.point(20,20)}),
        ];

        globe.settings = {
            "bufferRadius" : 0.5,
            "numberOfClusters": 2
        };

        return globe;
    }

    function initEvent() {
        $('.msgBtn').click(function(){
            $('.message-box').hide();
        })

        var items = $('.layer');
        items.each(function(){
            $(this).click(function(){
                // reomve all backgrounds
                items.each(function(){
                    $(this).css({"color":"#fff"});
                })

                $(this).css({"color":"#1bbc9c"});
            })
        })
    }

    function initMap() {
        map = L.map('map',{
            attributionControl: false,
            fullscreenControl: true,
            fullscreenControlOptions: {
                position: 'topleft'
            },
            // drawControl: true
        }).setView([30.5309, 114.3545], 16);

        GLOBE.layerList['default'] = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);
    }

    function initNav() {

        // 初始化折叠面板
        $(".edit").click(function(){
            GLOBE.toolVis = !GLOBE.toolVis;
            if(GLOBE.toolVis){
                $('#map').animate({marginLeft:"0"},'slow');

                // 这里有点hack，因为js无法保证顺序，但是执行顺序在这里很重要
                setTimeout(function(){
                    $('#tool-wrap').hide();
                },1000);
            } else {
                $('#map').animate({marginLeft:"16%"},'slow');
                $('#tool-wrap').show();
            }
        });

        $(function () { $('#collapseOne').collapse('show')});
        $(function () { $('#collapseTwo').collapse('show')});
        $(function () { $('#collapseThree').collapse('show')});
        $(function () { $('#collapseFour').collapse('hide')});

    }

    function initEdit() {
        $('.addMarker').click(function(){
            GLOBE.setMarker = !GLOBE.setMarker;
            if(GLOBE.setMarker){
                $('.addMarker').css({"color":GLOBE.colors.darkGreen});
            }else {
                $('.addMarker').css({"color":GLOBE.colors.white});
            }
            if(GLOBE.delMarker){
                GLOBE.delMarker = !GLOBE.delMarker;
                $('.delMarker').css({"color":GLOBE.colors.white});
            }
        })

        $('.delMarker').click(function(){
            GLOBE.delMarker = !GLOBE.delMarker;
            if(GLOBE.delMarker){
                $('.delMarker').css({"color":GLOBE.colors.darkGreen});
            }else {
                $('.delMarker').css({"color":GLOBE.colors.white});
            }
            if(GLOBE.setMarker){
                GLOBE.setMarker = !GLOBE.setMarker;
                $('.addMarker').css({"color":GLOBE.colors.white});
            }
        })

        $('.delAllMarkers').click(function(){
            if(GLOBE.markers.length == 0) return;

            GLOBE.markers.forEach(function(marker){
                marker.removeFrom(map);
            })
            GLOBE.markers = [];
        })

        map.on("click",function(e){
            if(GLOBE.setMarker){
                // 设置marker
                var coord = e.latlng;
                var marker = L.marker(coord).addTo(map)
                  .bindPopup("经纬度:" + Math.floor(coord.lat * 10000) / 10000 + "," + Math.floor(coord.lng * 10000) / 10000)

                // 将marker加入list
                var markers = GLOBE.markers;
                markers.push(marker);

                // 为marker注册delete事件，方便管理
                marker.on('click',function(){
                    if(GLOBE.delMarker){
                        markers.splice($.inArray(marker,markers),1);
                        marker.removeFrom(map);
                    }
                })

            }
        })

        // 监听所有的设置更改
        $('input').bind('input propertychange', function(e) {
            var input = e.target;
            var id = input.id;
            if(id == "editRadius"){
                var radius = input.value;
                if(radius == "") radius = 0.5;
                GLOBE.settings.bufferRadius = radius;

                $("#buffer").trigger("click");
                $("#buffer").trigger("click");
            }else if (id == 'editClusterNums') {
                var num = input.value;
                if(num == "") num = 2;
                GLOBE.settings.numberOfClusters = num;

                $("#clustersKmeans").trigger("click");
                $("#clustersKmeans").trigger("click");
            }
        });
    }

    function initLayers() {
        /*各类的底图*/
        var layerList = GLOBE.layerList;

        var layerBtns = $('.layer');

        // 注册所有的图层
        for (var i = 0; i < layerBtns.length; i++) {
            var Id = layerBtns[i].id;
            layerList[Id] = L.tileLayer.provider(Id);

        }
        // 绑定click
        for (var i = 0; i < layerBtns.length; i++) {
            layerBtns[i].onclick = switchLayer;
        }

        function switchLayer(layer) {
            var layerId = layer.currentTarget.id;
            //remove other layers
            for(var key in layerList){
                map.removeLayer(layerList[key]);
            }
            layerList[layerId].addTo(map);
        }
    }

    function initAnalyse() {
        var spaLayer = GLOBE.spaLayer;

        // 注册空间分析的操作
        regisAnalyse(3,'convex');
        regisAnalyse(2,'bbox');
        regisAnalyse(3,'tin');
        regisAnalyse(3,'voronoi');
        regisAnalyse(1,'buffer');
        regisAnalyse(2,'clustersKmeans');

        function regisAnalyse(ptNum,eventName) {
            $('#' + eventName).click(function() {
                // 宏定义
                var eventJSON;
                var event;
                var jsonList = {
                    "type": "FeatureCollection",
                    "features":[]
                };

                // 检查当前点数是否够实现功能(通用)
                if(GLOBE.markers.length < ptNum){
                    showMessage("请至少添加" + ptNum + "个点再使用本功能");
                    return;
                }
                if (typeof(spaLayer[eventName]) !== "undefined"){
                    spaLayer[eventName].removeFrom(map);
                    delete(spaLayer[eventName]);
                    $('#'+eventName).css({"color":GLOBE.colors.white})
                    return;
                }

                $('#' + eventName).css({"color":GLOBE.colors.darkGreen})

                // 处理缓冲区
                if(eventName == "buffer") {
                    var bufferUnion;
                    GLOBE.markers.forEach(function(marker){
                        var coord = marker.toGeoJSON()
                        var buffer = turf.buffer(coord,GLOBE.settings.bufferRadius);
                        if(typeof(bufferUnion) == "undefined"){
                            bufferUnion = buffer;
                        }else {
                            bufferUnion = turf.union(buffer,bufferUnion);
                        }
                    });

                    event = L.geoJSON(bufferUnion);
                    spaLayer['buffer'] = event;
                    event.addTo(map);
                    return;
                }

                // 获取页面上所有的点（通用）
                GLOBE.markers.forEach(function(marker){
                    var coord = marker.toGeoJSON()
                    jsonList['features'].push(coord);
                });


                // 使用 turf.js 进行相应的空间分析(通用)
                if(eventName == 'bbox'){
                    var bbox = turf.bbox(jsonList);
                    eventJSON = turf.bboxPolygon(bbox);
                }
                else if(eventName == 'voronoi') {
                    var bbox = turf.bbox(jsonList);
                    eventJSON = turf.voronoi(jsonList,{
                        bbox: bbox
                    })
                }
                else if(eventName == 'clustersKmeans'){
                    eventJSON = turf[eventName](jsonList,{
                        numberOfClusters: GLOBE.settings.numberOfClusters
                    });
                }else {
                    eventJSON = turf[eventName](jsonList);
                }


                // 空间分析结果从geoJSON转为可用的格式（通用）
                if(eventName == "clustersKmeans"){
                    event = L.geoJSON(eventJSON, {
                        pointToLayer: function(feature,latlng){
                            var clusterId = feature.properties.cluster;
                            var maxIcons = GLOBE.icons.length
                            if(clusterId >= maxIcons){
                                showMessage('聚类上限为' + maxIcons + "个");
                                clusterId = maxIcons - 1;
                                $('#editClusterNums').val("");
                            }
                            return L.marker(latlng,{
                                icon: GLOBE.icons[clusterId]
                            });
                        }
                    })
                } else {
                    event = L.geoJSON(eventJSON);
                }


                // 添加空间分析后的结果到地图上和数组里(通用)
                spaLayer[eventName] = event;
                event.addTo(map);
            })
        }
    }

    /* Util Funcs */
    function showMessage(msg){
        $('.msgContent')[0].innerHTML = msg;
        $('.message-box')[0].style.display = "inline-block";
    }

    </script>
  </body>
</html>
